# Руководство по безопасному расширению лимитов Telegram

## Текущие лимиты (консервативные)

### Per-user лимиты
- **10 сообщений/минуту** на пользователя
- **50 сообщений/час** на пользователя
- **Минимум 2 секунды** между сообщениями

### Глобальные лимиты (на весь аккаунт)
- **25 сообщений/минуту** (безопасный запас от рекомендуемых 30)
- **500 сообщений/час**

### Лимиты по типам чатов
- **Личные чаты**: 20 сообщений/минуту
- **Группы**: 10 сообщений/минуту
- **Каналы**: 5 сообщений/минуту

## Лимиты Telegram (официальные)

Согласно документации Telethon и практике:
- **Теоретический максимум**: 1 сообщение/секунду = 60/мин
- **Безопасный лимит**: 20-30 сообщений/минуту на весь аккаунт
- **При превышении**: FloodWait (автоматическое ожидание)
- **Блокировка аккаунта**: при регулярных нарушениях на 12-24 часа

## Стратегии безопасного расширения

### Вариант 1: Умеренное расширение (рекомендуется) ⭐

```yaml
rate_limiting:
  enabled: true
  messages_per_minute: 15  # было 10, увеличиваем до 15
  messages_per_hour: 80    # было 50, увеличиваем до 80
  min_interval_seconds: 1  # было 2, уменьшаем до 1
  
  global:
    enabled: true
    messages_per_minute: 28  # было 25, увеличиваем до 28 (ближе к безопасному максимуму)
    messages_per_hour: 600   # было 500, увеличиваем до 600
    
  chat_type_limits:
    private: 25  # было 20, увеличиваем до 25 для более активного общения
    group: 12   # было 10, немного увеличиваем
    channel: 5  # оставляем консервативным
```

**Плюсы:**
- ✅ Безопасно (в пределах рекомендуемых лимитов Telegram)
- ✅ Заметное улучшение для активного общения
- ✅ Адаптивная система автоматически снизит при FloodWait

**Риски:**
- ⚠️ Низкий риск (если не будет регулярных FloodWait)

### Вариант 2: Агрессивное расширение (только если нет FloodWait)

```yaml
rate_limiting:
  enabled: true
  messages_per_minute: 20  # увеличиваем до 20
  messages_per_hour: 100   # увеличиваем до 100
  min_interval_seconds: 1  # уменьшаем до 1
  
  global:
    enabled: true
    messages_per_minute: 30  # максимальный безопасный лимит
    messages_per_hour: 800  # увеличиваем значительно
    
  chat_type_limits:
    private: 30  # максимальный лимит для личных чатов
    group: 15    # увеличиваем для групп
    channel: 8   # немного увеличиваем
```

**Плюсы:**
- ✅ Максимальная производительность
- ✅ Адаптивная система защитит от блокировок

**Риски:**
- ⚠️ Средний риск (близко к границе, нужно мониторить FloodWait)
- ⚠️ При регулярных FloodWait адаптивная система снизит лимиты автоматически

### Вариант 3: Умное расширение с мониторингом (оптимально) ⭐⭐⭐

Используем текущие настройки, но полагаемся на адаптивную систему:

1. **Начинаем с умеренных лимитов** (Вариант 1)
2. **Адаптивная система автоматически расширит лимиты** при отсутствии FloodWait
3. **Мониторим статистику** через `uv run telegram-ai health`

```yaml
rate_limiting:
  adaptive:
    enabled: true
    reduction_on_floodwait_percent: 20  # снижение на 20% при FloodWait
    recovery_period_minutes: 5  # проверка каждые 5 минут (быстрее восстановление)
    recovery_increment_percent: 10  # восстановление на 10% за период (быстрее расширение)
```

## Рекомендации

### Для активного общения (один пользователь)
- Используйте **Вариант 1** (умеренное расширение)
- Установите `chat_type_limits.private: 25-30`
- Уменьшите `min_interval_seconds: 1`

### Для массовой рассылки (много пользователей)
- Оставьте глобальные лимиты консервативными (25-28/мин)
- Увеличьте per-user лимиты умеренно (15-20/мин)
- Мониторьте FloodWait статистику

### Мониторинг

Проверяйте статистику регулярно:
```bash
uv run telegram-ai health
```

Обращайте внимание на:
- Количество FloodWait событий за 24ч
- Текущие адаптивные лимиты (должны восстановиться до базовых)
- Если адаптивные лимиты постоянно снижены → лимиты слишком высокие

## Процесс безопасного расширения

1. **Начните с Варианта 1** (умеренное расширение)
2. **Используйте систему 1-2 дня** с мониторингом
3. **Проверьте статистику FloodWait**:
   - Если FloodWait = 0 → можно увеличить дальше
   - Если FloodWait > 0, но редкие → текущие лимиты оптимальны
   - Если FloodWait частые → снизьте лимиты
4. **Постепенно увеличивайте** при отсутствии проблем

## Важно ⚠️

- **Никогда не устанавливайте** глобальный лимит выше 30/мин (риск блокировки)
- **Мониторьте FloodWait** - это индикатор превышения лимитов Telegram
- **Адаптивная система защитит** от блокировок, но лучше не доводить до этого
- **При блокировке аккаунта** восстановление занимает 12-24 часа

## Текущий статус адаптивной системы

Система автоматически:
- ✅ Снижает лимиты на 20% при получении FloodWait
- ✅ Восстанавливает лимиты на 5% каждые 10 минут при отсутствии FloodWait
- ✅ Логирует все FloodWait события для анализа
- ✅ Показывает критическое предупреждение при FloodWait > 60 секунд

