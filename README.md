# Telegram AI Assistant

Персональный AI-ассистент для личного Telegram аккаунта с интеграцией локального AI-сервера, памятью контекста, Google Calendar, защитой от флуда, обработкой голосовых сообщений и скриптом продаж.

## Быстрый старт

```bash
# Одна команда для запуска (замените путь на ваш реальный путь к проекту):
cd ~/development/TelegramAI && uv sync && uv run telegram-ai

# Или если проект в другом месте:
cd /Users/ваше_имя/путь/к/TelegramAI && uv sync && uv run telegram-ai
```

**Примечание:** Замените `~/development/TelegramAI` на реальный путь к директории проекта.

## Требования

- Python 3.12
- uv (менеджер пакетов)
- Локальный AI-сервер с OpenAI-compatible API (vLLM) на порту 8000
- (Опционально) ASR сервер для транскрибации голосовых сообщений на порту 8001
- Telegram аккаунт
- (Опционально) Google Calendar API credentials

## Установка

1. Клонируйте репозиторий и запустите:
```bash
git clone <repository-url>
cd TelegramAI
uv sync
```

2. Создайте `.env` файл из шаблона (если есть):
```bash
cp .env.example .env
# Отредактируйте .env и добавьте ваши credentials
```

3. Запустите приложение:
```bash
uv run telegram-ai
```

## Конфигурация

### 1. Получение Telegram API credentials

1. Перейдите на [my.telegram.org](https://my.telegram.org)
2. Войдите используя ваш номер телефона
3. Перейдите в раздел "API development tools"
4. Создайте новое приложение, указав:
   - App title: любое название
   - Short name: короткое название
   - Platform: Desktop
5. Скопируйте `api_id` и `api_hash`

### 2. Настройка .env файла

Отредактируйте `.env` файл и добавьте:

```env
TELEGRAM_API_ID=ваш_api_id
TELEGRAM_API_HASH=ваш_api_hash
TELEGRAM_PHONE=+7XXXXXXXXXX

# Опционально, если AI-сервер требует API ключ
AI_SERVER_API_KEY=

# Google Calendar (опционально)
GOOGLE_CALENDAR_ENABLED=false
```

### 3. Настройка config.yaml

Базовые настройки уже настроены в `config.yaml`. Основные параметры:

**AI сервер:**
- `ai_server.base_url` - URL вашего AI-сервера (по умолчанию: `http://100.93.82.48:8000`)
- `ai_server.model` - название модели (по умолчанию: `Qwen/Qwen2.5-14B-Instruct-AWQ`)
- `ai_server.timezone` - часовой пояс для даты/времени (по умолчанию: `Europe/Moscow`)

**Память и контекст:**
- `memory.context_window` - количество последних сообщений для контекста (по умолчанию: 10)
- `memory.max_history_days` - максимальный возраст истории (по умолчанию: 30 дней)

**Фильтры Telegram:**
- `telegram.handle_private_chats` - обрабатывать личные чаты (по умолчанию: `true`)
- `telegram.handle_groups` - обрабатывать группы (по умолчанию: `false`)
- `telegram.handle_channels` - обрабатывать каналы (по умолчанию: `false`)

**Защита от флуда (Rate Limiting):**
- `rate_limiting.enabled` - включить защиту от флуда (по умолчанию: `true`)
- `rate_limiting.messages_per_minute` - максимум сообщений в минуту (по умолчанию: 10)
- `rate_limiting.messages_per_hour` - максимум сообщений в час (по умолчанию: 50)
- `rate_limiting.block_duration_minutes` - длительность блокировки при превышении (по умолчанию: 10 минут)

**ASR сервер (голосовые сообщения):**
- `asr_server.base_url` - URL ASR сервера (по умолчанию: `http://100.93.82.48:8001`)
- `asr_server.enabled` - включить обработку голосовых (по умолчанию: `true`)

**Скрипт продаж:**
- `sales_flow.enabled` - включить скрипт продаж (по умолчанию: `true`)

**Google Calendar:**
- `google_calendar.auto_create_consultations` - автоматически создавать встречи (по умолчанию: `true`)
- `google_calendar.available_slots` - доступные слоты времени для встреч

### 4. Google Calendar (опционально)

Если хотите использовать интеграцию с Google Calendar:

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект
3. Включите Google Calendar API
4. Создайте OAuth 2.0 credentials (Desktop app)
5. Скачайте `credentials.json` и поместите в `credentials/google-calendar.json`
6. Установите `GOOGLE_CALENDAR_ENABLED=true` в `.env`

## Запуск

### Первая авторизация

При первом запуске потребуется:

1. Запустите приложение:
```bash
uv run telegram-ai
```

2. Введите код подтверждения, который придет в Telegram
3. Если включена 2FA, введите пароль

Сессия сохранится в `sessions/scanovichai.session` и повторная авторизация не потребуется.

### Последующие запуски

Просто запустите:
```bash
uv run telegram-ai
```

## Использование

### Автоматические ответы

Ассистент автоматически отвечает на сообщения в личных чатах (если включено в `config.yaml`). Ответы генерируются с учетом:
- Контекста предыдущих сообщений
- Актуальной даты и времени (автоматически добавляется в промпт)
- Текущего этапа скрипта продаж (если включен)

### Голосовые сообщения

Если ASR сервер включен (`asr_server.enabled: true`), ассистент автоматически:
1. Принимает голосовые сообщения
2. Транскрибирует их через ASR сервер
3. Обрабатывает транскрипт как обычное текстовое сообщение
4. Отвечает текстом

### Скрипт продаж (Sales Flow)

Если скрипт продаж включен (`sales_flow.enabled: true`), ассистент проходит через этапы:
1. **Приветствие** - знакомство и выявление потребностей
2. **Выявление потребностей** - уточняющие вопросы
3. **Презентация услуг** - рассказ о возможностях Scanovich.ai
4. **Работа с возражениями** - ответы на сомнения
5. **Предложение консультации** - предложение встречи
6. **Согласование времени** - помощь в выборе времени

Переходы между этапами происходят автоматически на основе ключевых слов в сообщениях пользователя.

### Команды Google Calendar

Если интеграция включена:

- `/calendar` или `/events` - показать предстоящие события
- `/create_event Название события | Описание` - создать событие

### Автоматическое создание встреч

Если включено (`google_calendar.auto_create_consultations: true`), ассистент:
- Распознает запросы на консультацию ("хочу консультацию", "когда можем встретиться")
- Извлекает время из сообщения (если указано)
- Предлагает доступные слоты времени (если время не указано)
- Автоматически создает событие в Google Calendar при подтверждении

### Защита от флуда

Ассистент автоматически защищает от:
- Слишком частых сообщений (лимиты настраиваются в `config.yaml`)
- Повторяющихся сообщений
- Слишком коротких/длинных сообщений
- При превышении лимитов - временная блокировка с понятным сообщением

## Структура проекта

```
TelegramAI/
├── src/telegram_ai/          # Исходный код
│   ├── ai_client.py           # Клиент для AI сервера (VLLM)
│   ├── calendar.py            # Интеграция с Google Calendar
│   ├── client.py              # Основной Telegram клиент
│   ├── config.py              # Конфигурация приложения
│   ├── memory.py              # Управление памятью и контекстом
│   ├── rate_limiter.py        # Защита от флуда
│   ├── sales_flow.py          # Скрипт продаж (state machine)
│   ├── voice_handler.py       # Обработка голосовых сообщений (ASR)
│   └── main.py                # Точка входа
├── tests/                     # Тесты
├── data/                      # SQLite база данных (создается автоматически)
├── sessions/                  # Telethon сессии (создаются автоматически)
├── credentials/               # Google Calendar credentials (если используется)
├── logs/                      # Логи приложения (создается автоматически)
├── temp_audio/                # Временные аудио файлы (создается автоматически)
├── config.yaml                # Конфигурация
├── .env                       # Секреты (не коммитится)
└── README.md
```

## Разработка

### Установка dev зависимостей

```bash
uv sync --dev
```

### Запуск тестов

```bash
uv run pytest
```

### Линтинг

```bash
uv run ruff check .
uv run pyright
```

## Безопасность

⚠️ **Важно:**

- Никогда не коммитьте `.env` файл
- Не коммитьте `sessions/` директорию (сессии содержат токены)
- Не коммитьте `credentials/` директорию (OAuth credentials)
- Не коммитьте `data/` директорию (база данных может содержать личные данные)

Все эти директории уже добавлены в `.gitignore`.

## Устранение проблем

### Ошибка "Configuration validation failed"

Убедитесь, что все переменные окружения установлены в `.env`:
- `TELEGRAM_API_ID`
- `TELEGRAM_API_HASH`
- `TELEGRAM_PHONE`

### Ошибка подключения к AI-серверу

Проверьте:
1. AI-сервер запущен и доступен по адресу в `ai_server.base_url`
2. `ai_server.base_url` в `config.yaml` правильный
3. Нет блокировки файрвола
4. Модель указана правильно в `ai_server.model`

### Ошибка подключения к ASR серверу

Если обработка голосовых не работает:
1. Проверьте, что ASR сервер запущен на порту 8001 (или указанном в `asr_server.base_url`)
2. Проверьте доступность endpoint `/transcribe`
3. Убедитесь, что `asr_server.enabled: true` в `config.yaml`

### Ошибка авторизации Telegram

1. Убедитесь, что credentials правильные
2. Удалите `sessions/scanovichai.session` и попробуйте снова
3. Проверьте, что номер телефона в формате `+7XXXXXXXXXX`

### Проблемы с rate limiting

Если вас заблокировали:
1. Подождите указанное время (по умолчанию 10 минут)
2. Или отключите rate limiting временно: `rate_limiting.enabled: false` в `config.yaml`
3. Или увеличьте лимиты в `config.yaml`

### Логи

Все логи сохраняются в `logs/telegram-ai-YYYYMMDD.log` с детальной информацией для отладки.

## Возможности

### Основные функции

- ✅ **Автоматические ответы** - интеллектуальные ответы на основе контекста диалога
- ✅ **Память контекста** - сохранение истории разговоров в SQLite БД
- ✅ **Динамическая дата/время** - AI всегда знает актуальную дату и время
- ✅ **Защита от флуда** - rate limiting с настраиваемыми лимитами
- ✅ **Голосовые сообщения** - автоматическая транскрибация через ASR сервер
- ✅ **Скрипт продаж** - структурированный процесс продаж с отслеживанием этапов
- ✅ **Автоматические встречи** - создание событий в Google Calendar при запросах
- ✅ **Детальное логирование** - логи в файлы и консоль для отладки

### Технические особенности

- Модульная архитектура с четким разделением ответственности
- Конфигурация через YAML + переменные окружения
- Fail-fast подход - валидация конфигурации при старте
- Обработка ошибок с понятными сообщениями пользователю
- Поддержка всех типов сообщений Telegram (текст, голос, аудио)

## Лицензия

MIT

## Автор

FUYOH666 (iamfuyoh@gmail.com)

