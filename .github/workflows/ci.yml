name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: uv sync
    
    - name: Lint with ruff
      run: uv run ruff check .
    
    - name: Format check with ruff
      run: uv run ruff format --check .
    
    - name: Type check with pyright
      run: uv run pyright
    
    - name: Security check with bandit
      run: uv run bandit -r src services shared -c pyproject.toml
    
    - name: Spell check with codespell
      run: uv run codespell --ignore-words-list=nd,te,fo,ba,adres,ba,referer
    
    - name: Audit dependencies with pip-audit
      run: uv run pip-audit --desc
    
    - name: Run tests
      run: uv run pytest

  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Build Docker images for security scan
      run: |
        docker build -t telegram-ai-bot:test -f services/telegram-bot/Dockerfile .
        docker build -t telegram-ai-api:test -f services/api-gateway/Dockerfile .
        docker build -t telegram-ai-worker:test -f services/worker/Dockerfile .
        docker build -t telegram-ai-analytics:test -f services/analytics/Dockerfile .
    
    - name: Scan Docker images with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'telegram-ai-bot:test'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
    
    - name: Scan Docker images with Trivy (API Gateway)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'telegram-ai-api:test'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
    
    - name: Scan Docker images with Trivy (Worker)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'telegram-ai-worker:test'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
    
    - name: Scan Docker images with Trivy (Analytics)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'telegram-ai-analytics:test'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

