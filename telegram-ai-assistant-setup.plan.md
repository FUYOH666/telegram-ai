# Дорожная карта улучшений Telegram AI-ассистента

## Текущее состояние проекта

### Что работает

- ✅ Telegram авторизация и сохранение сессии
- ✅ Подключение к AI серверу (VLLM на порту 8000)
- ✅ Модель: `Qwen/Qwen2.5-14B-Instruct-AWQ` (обновлена)
- ✅ Сохранение контекста разговоров в SQLite
- ✅ Детальное логирование в файлы
- ✅ Google Calendar интеграция (базовая)

### Архитектура сервисов

#### Локальный сервер (100.93.82.48)

**VLLM AI-сервис (порт 8000)**
- URL: `http://100.93.82.48:8000`
- Модель: `Qwen/Qwen2.5-14B-Instruct-AWQ`
- `max_model_len`: 8192 токенов
- API: OpenAI-compatible

**ASR сервис (порт 8001)**
- URL: `http://100.93.82.48:8001`
- API: FastAPI с Swagger (`/docs`)
- Endpoint: `/transcribe` (POST multipart/form-data)
- Статус: ✅ Готов к использованию

---

## План улучшений

### Этап 1: Защита от флуда и DDoS [P0] - КРИТИЧНО

**Проблема:** Отсутствие защиты от флуда может привести к блокировке аккаунта Telegram.

**Что нужно сделать:**
- [ ] Создать модуль `src/telegram_ai/rate_limiter.py`
- [ ] Добавить таблицу `rate_limits` в БД (`memory.py`)
- [ ] Реализовать простой счетчик за период (достаточно для защиты)
- [ ] Интегрировать проверку в `client.py` перед обработкой сообщений
- [ ] Добавить конфигурацию в `config.yaml` и `config.py`
- [ ] Логирование блокировок и сообщения пользователям

**Результат:** Защита от флуда с настраиваемыми лимитами.

---

### Этап 2: Исправление даты/времени [P0] - КРИТИЧНО

**Проблема:** VLLM возвращает дату тренировки модели вместо актуальной даты.

**Что нужно сделать:**
- [ ] Добавить метод `_get_dynamic_system_prompt()` в `ai_client.py`
- [ ] Реализовать конвертацию UTC в МСК (UTC+3)
- [ ] Форматировать дату на русском языке
- [ ] Добавлять актуальную дату в системный промпт перед каждым запросом
- [ ] Добавить настройки timezone в конфигурацию

**Результат:** AI всегда знает актуальную дату и время.

---

### Этап 3: Улучшение естественности общения [P1]

**Что нужно сделать:**
- [ ] Обновить системный промпт в `config.yaml`
- [ ] Настроить параметры генерации (temperature, top_p)
- [ ] Добавить инструкции по вариативности стилей

**Результат:** Более естественные и человечные ответы.

---

### Этап 4: Обработка голосовых сообщений [P1]

**Что нужно сделать:**
- [ ] Создать модуль `src/telegram_ai/voice_handler.py`
- [ ] Реализовать клиент для ASR сервиса (порт 8001)
- [ ] Добавить обработку `event.message.voice` и `event.message.audio` в `client.py`
- [ ] Скачивание аудио файлов из Telegram
- [ ] Отправка на транскрипцию через `/transcribe` endpoint
- [ ] Использование транскрипта для генерации ответа
- [ ] Добавить конфигурацию ASR сервера

**Результат:** Поддержка голосовых сообщений с автоматической транскрипцией.

---

### Этап 5: Скрипт продаж (Sales Flow) [P1]

**Что нужно сделать:**
- [ ] Создать модуль `src/telegram_ai/sales_flow.py`
- [ ] Реализовать state machine с этапами:
  - greeting (приветствие)
  - needs_discovery (выявление потребностей)
  - presentation (презентация услуг)
  - objections (ответы на возражения)
  - consultation_offer (предложение консультации)
  - scheduling (согласование времени)
- [ ] Сохранение состояния в `UserContext` (БД)
- [ ] Интеграция в `client.py` с модификацией системного промпта
- [ ] Добавить конфигурацию скрипта

**Результат:** Структурированный процесс продаж с отслеживанием прогресса.

---

### Этап 6: Автоматическое создание встреч [P1]

**Что нужно сделать:**
- [ ] Расширить `calendar.py` методами:
  - `detect_consultation_request()` - распознавание запросов
  - `extract_time_from_message()` - извлечение времени
  - `suggest_available_slots()` - предложение слотов
- [ ] Интеграция в `client.py` после ответа AI
- [ ] Автоматическое создание событий в Google Calendar
- [ ] Добавить настройки доступных слотов времени

**Результат:** Автоматическое создание встреч при запросах на консультацию.

---

## Последовательность реализации

### Фаза 1: Критичные улучшения (P0)
1. **Этап 1** - Защита от флуда
2. **Этап 2** - Исправление даты/времени

### Фаза 2: Важные функции (P1)
3. **Этап 3** - Естественность общения
4. **Этап 4** - Голосовые сообщения (можно параллельно с этапом 3)
5. **Этап 5** - Скрипт продаж
6. **Этап 6** - Автоматические встречи (зависит от этапа 5)

---

## Файлы для изменения

### Новые модули:
- `src/telegram_ai/rate_limiter.py` - защита от флуда
- `src/telegram_ai/voice_handler.py` - обработка голосовых
- `src/telegram_ai/sales_flow.py` - скрипт продаж

### Изменяемые файлы:
- `src/telegram_ai/config.py` - новые классы конфигурации
- `src/telegram_ai/ai_client.py` - динамический системный промпт
- `src/telegram_ai/client.py` - интеграция всех функций
- `src/telegram_ai/memory.py` - таблица `rate_limits`
- `src/telegram_ai/calendar.py` - автоматические встречи
- `config.yaml` - новые секции конфигурации

---

## Детали реализации

### Rate Limiting (вариант B - простой счетчик)
- Простой счетчик сообщений за период (минута/час)
- Reset счетчика при смене окна времени
- Достаточно для защиты от флуда
- Проще в реализации чем sliding window

### ASR Integration
- Endpoint: `POST /transcribe`
- Формат: `multipart/form-data` с файлом
- Ответ: JSON с полем `text` (транскрипт)
- Использовать `httpx` для отправки запросов

### Sales Flow State Machine
- Состояние хранится в `user_context.context_data` (JSON)
- Переходы между этапами на основе ключевых слов
- Модификация системного промпта в зависимости от этапа

---

## Конфигурация

Все новые настройки будут добавлены в `config.yaml`:

```yaml
rate_limiting:
  enabled: true
  messages_per_minute: 10
  messages_per_hour: 50
  min_interval_seconds: 2
  block_duration_minutes: 10

ai_server:
  timezone: Europe/Moscow
  # ... существующие настройки

asr_server:
  base_url: http://100.93.82.48:8001
  timeout: 60
  enabled: true

sales_flow:
  enabled: true
  # ... настройки этапов

google_calendar:
  auto_create_consultations: true
  default_consultation_duration_minutes: 60
  available_slots: ["09:00", "10:00", "11:00", "14:00", "15:00", "16:00"]
```

---

## Следующие шаги

Начинаем с **Фазы 1** (критичные улучшения):
1. Реализация защиты от флуда
2. Исправление даты/времени

После завершения Фазы 1 переходим к **Фазе 2** (важные функции).
