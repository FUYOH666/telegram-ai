# Changelog

## [0.7.0] - 2025-11-06

### Added

- **Система уверенности для извлечения слотов (Confidence-based Slot Extraction)**
  - `SlotExtractor` теперь возвращает confidence score (0.0-1.0) для каждого извлеченного слота
  - Автоматическое вычисление confidence на основе паттернов (телефон, email, имена, числа)
  - Хранение слотов с метаданными: `value`, `source`, `confidence`, `updated_at`
  - Методы в `Memory` для работы с confidence: `update_slot_with_confidence()`, `get_slots_with_confidence()`

- **Мягкие уточнения и подтверждения на основе confidence**
  - Автоматическая генерация уточняющих вопросов при confidence < 0.6
  - Мягкие подтверждения ("Верно ли, что...?") при confidence 0.6-0.8
  - Использование информации без уточнений при confidence ≥ 0.8
  - Интеграция в промпт для этапа NEEDS_DISCOVERY

- **Fit-score система для квалификации лидов**
  - `SalesFlow.compute_fit_score()` вычисляет fit_score (0-100) на основе заполненных слотов
  - Формула: проблема (20) + метрики (20) + доступ к данным (15) + лицо принимающее решение (15) + бюджет (20) + сроки (10)
  - `get_fit_score_breakdown()` для детальной разбивки и логирования
  - Порог 60 для предложения встречи (настраивается через `FIT_SCORE_THRESHOLD`)
  - Интеграция в `should_offer_consultation()` с поддержкой явных запросов

- **Событийная система (Event-driven architecture)**
  - Новый модуль `events.py` с `EventBus` для публикации и подписки на события
  - События: `NEW_MESSAGE`, `SLOT_FOUND`, `SLOT_CORRECTION`, `INTENT_CHANGED`, `TIME_PROPOSED`, `CONSENT_GIVEN`, `CONFLICT_FOUND`
  - `SalesFlow` подписывается на события и может реагировать на изменения
  - Гибридный подход: события + существующая машина состояний (без рефакторинга ядра)

- **Предбронь встреч (Tentative Events)**
  - `Calendar.create_tentative_event()` создает предбронь на 15 минут
  - `Calendar.confirm_tentative_event()` подтверждает предбронь (убирает метку [TENTATIVE])
  - `Calendar.cancel_tentative_event()` отменяет предбронь
  - Автоматическое предложение подтверждения пользователю
  - Интеграция в процесс создания встреч

- **Идемпотентность создания встреч**
  - `Calendar.generate_event_hash()` генерирует SHA1 хэш для проверки дубликатов
  - Проверка существующих событий перед созданием
  - Предотвращение создания дубликатов встреч

- **Улучшенное предложение слотов времени**
  - `Calendar.suggest_time_slots()` предлагает слоты с учетом таймзоны пользователя
  - Поддержка часового пояса пользователя из контекста
  - Проверка конфликтов перед предложением
  - Пропуск выходных дней

- **PDPA согласия (Consent Management)**
  - Новый модуль `consent.py` с `ConsentManager` для управления согласиями
  - Типы согласий: `pdpa_profile` (сбор профиля), `calendar_invite` (создание встреч)
  - Автоматический запрос согласия при сборе контактов и создании встреч
  - Парсинг ответов пользователя (да/нет) с поддержкой множества вариантов
  - Хранение согласий в контексте пользователя с timestamp
  - Публикация события `CONSENT_GIVEN` при получении согласия

- **Мини-повестка встреч**
  - `MeetingSummary.generate_mini_agenda()` генерирует повестку на основе слотов и fit_score
  - Включение fit_score в отчеты для владельца
  - Предупреждения при низком fit_score (< 60)

### Changed

- **Формат хранения слотов**
  - Слоты теперь хранятся в формате: `{"field": {"value": "...", "source": "llm", "confidence": 0.9, "updated_at": "..."}}`
  - Обратная совместимость: старый формат (просто `value`) автоматически преобразуется
  - Методы `get_slots()` возвращают старый формат для совместимости

- **Логика предложения встреч**
  - `should_offer_consultation()` теперь использует fit_score вместо только количества сообщений
  - Предложение встречи только при fit_score ≥ 60 ИЛИ явном запросе пользователя
  - Учет явных запросов на встречу (ключевые слова: "созвониться", "встретиться", "поговорить")

- **Процесс создания встреч**
  - Создание предброни вместо сразу финальной встречи
  - Запрос согласия перед созданием встречи
  - Проверка идемпотентности перед созданием
  - Предложение слотов с учетом таймзоны пользователя

- **Системный промпт для NEEDS_DISCOVERY**
  - Добавлены правила уточнения при низкой уверенности
  - Примеры уточняющих вопросов и мягких подтверждений
  - Инструкции по работе с confidence

### Technical

- **Новые модули**
  - `src/telegram_ai/events.py` - событийная система
  - `src/telegram_ai/consent.py` - управление согласиями

- **Обновленные модули**
  - `slot_extractor.py` - поддержка confidence
  - `memory.py` - методы для работы с confidence и согласиями
  - `sales_flow.py` - fit_score, методы для confidence, подписка на события
  - `calendar.py` - предбронь, идемпотентность, улучшенное предложение слотов
  - `meeting_summary.py` - мини-повестка, fit_score в отчетах
  - `client.py` - интеграция всех новых возможностей

- **Импорты**
  - Добавлен `import time` в `client.py` для timestamp событий
  - Добавлен `import hashlib` в `calendar.py` для генерации хэшей
  - Добавлен `import json` в `memory.py` для работы с контекстом

### Documentation

- Обновлен CHANGELOG.md с описанием всех изменений версии 0.7.0

## [0.6.0] - 2025-11-07

### Fixed

- **Исправлены ошибки запуска Telegram Bot**
  - Исправлен импорт в `scripts/start_telegram_bot.py` для корректной работы относительных импортов
  - Добавлен `db_path` в `MemoryConfig` для обратной совместимости со старым кодом
  - Бот успешно запускается и обрабатывает сообщения

- **Исправлены API Gateway роуты**
  - Реализована реальная логика работы с БД в endpoints
  - Исправлены импорты роутов через прямые пути
  - Все 8 API endpoints работают корректно

### Added

- **Скрипты запуска сервисов**
  - `scripts/start_telegram_bot.py` - запуск Telegram Bot
  - `scripts/start_api_gateway.py` - запуск API Gateway
  - `scripts/start_worker.py` - запуск Worker Service

- **Тесты**
  - `tests/test_api_gateway.py` - тесты для API Gateway
  - `tests/test_database.py` - тесты для базы данных
  - Pytest установлен и настроен

- **Документация**
  - `TESTING_REPORT.md` - полный отчет о тестировании
  - `VOICE_MESSAGES_STATUS.md` - статус поддержки голосовых сообщений
  - `FIXES.md` - описание исправлений ошибок

## [0.6.0] - 2025-11-06

### Added

- **Полная реорганизация в микросервисную архитектуру**
  - Новая структура проекта: `services/`, `shared/`, `infrastructure/`
  - Telegram Bot Service с поддержкой существующих подключений
  - API Gateway Service с FastAPI и REST endpoints
  - Analytics Service для экспорта в Google Sheets/ClickUp
  - Worker Service (Celery) для асинхронных задач

- **Поддержка PostgreSQL**
  - Миграции через Alembic
  - Обратная совместимость с SQLite
  - Новые модели БД для лидов, встреч, аналитики

- **Интеграция Redis**
  - Кеширование RAG запросов и embeddings
  - Очереди для асинхронных задач
  - Rate limiting через Redis

- **LangChain интеграция**
  - Базовая структура для цепочек и агентов
  - Подготовка к LangGraph для state machines

- **Docker Compose**
  - Локальная разработка с PostgreSQL и Redis
  - Dockerfile для каждого сервиса

- **Event-driven архитектура**
  - Схемы событий для event bus
  - Подготовка к интеграции с внешними системами

### Changed

- **Конфигурация**
  - Обновлен `config.yaml` с поддержкой PostgreSQL и Redis
  - Путь к Telethon сессии: `./sessions/scanovichai.session` → `./services/telegram-bot/sessions/scanovichai.session`

- **Зависимости**
  - Добавлены: FastAPI, LangChain, LangGraph, Redis, Celery, Alembic
  - Обновлен `pyproject.toml` с новыми зависимостями

### Migration

- Существующая Telethon сессия сохранена и перенесена
- База данных SQLite продолжает работать (опционально можно мигрировать в PostgreSQL)
- Все существующие подключения (vLLM, ASR серверы) работают без изменений

### Documentation

- Обновлен README.md с описанием новой архитектуры
- Добавлен MIGRATION_GUIDE.md для миграции
- Создан QUICKSTART.md для быстрого старта
- Добавлен TESTING_REPORT.md с результатами тестирования
- Добавлен VOICE_MESSAGES_STATUS.md со статусом голосовых сообщений
- Добавлен FIXES.md с описанием исправлений

## [0.5.1] - 2025-11-05

### Previous versions
(см. предыдущие версии CHANGELOG.md)
