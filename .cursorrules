# Project Rules для Telegram AI Assistant

## Общие принципы

- **Язык**: Русский для документации и комментариев
- **Философия**: Fail-fast подход, никаких fallback-заглушек, только реальные модули
- **Менеджер пакетов**: uv (не pip, не poetry)
- **Python версия**: 3.12 (единственная целевая)

## Структура проекта

- `src/telegram_ai/` — основной код приложения
- `tests/` — тесты (pytest)
- `scripts/` — утилиты и скрипты
- `config.yaml` — конфигурация (YAML + ENV переменные)
- `data/` — база данных SQLite и ChromaDB (не коммитится)

## Ключевые компоненты

### Memory (memory.py)
- Управляет историей разговоров в SQLite
- Всегда закрывать через `memory.close()` при остановке
- Использует SQLAlchemy с timeout=5.0 для предотвращения блокировок

### Client (client.py)
- Порядок закрытия: AI клиент → Voice Handler → Memory → Telethon клиент
- Всегда использовать `safe_reply()` для отправки сообщений (обработка FloodWait)
- Ошибки обработки сообщений не должны падать приложение

### Rate Limiting
- Многоуровневая защита: per-user + global + adaptive
- Автоматическая обработка FloodWait с адаптивными лимитами
- Все FloodWait события логируются

## Правила разработки

### Обработка ошибок
- Все критические операции в try-except
- Ошибки HTTP запросов логируются, но не падают приложение
- SQLite ошибки обрабатываются с понятными сообщениями

### Ресурсы
- Все соединения с БД закрываются в `finally` блоках
- HTTP клиенты закрываются в методах `close()`
- Memory закрывается перед Telethon клиентом

### Конфигурация
- Секреты только через ENV переменные (никогда в коде/конфигах)
- `.env` в `.gitignore`
- Валидация конфигурации при старте через pydantic-settings

### Тестирование
- Использовать pytest для всех тестов
- Минимальные тесты на критичный путь
- Тесты на валидацию конфига обязательны

## Специфичные правила

### Telegram API
- Всегда проверять rate limits перед отправкой
- Использовать `safe_reply()` с обработкой FloodWait
- Не отправлять сообщения если пользователь заблокирован

### База данных
- SQLite timeout=5.0 для автоматической разблокировки
- Все сессии закрываются в `finally` блоках
- При закрытии приложения: Memory.close() перед Telethon disconnect()

### Внешние интеграции
- AI сервер, ASR сервер, Google Calendar — все отключаемы через конфиг
- Ошибки внешних сервисов не падают приложение
- Retry механизмы для сетевых ошибок (но не для ReadTimeout)

## Чек-лист перед коммитом

- [ ] Код в правильной структуре (`src/telegram_ai/`)
- [ ] Зависимости закреплены в `pyproject.toml`, `uv.lock` актуален
- [ ] Конфигурация валидна
- [ ] Нет заглушек и "временных" решений
- [ ] Все ресурсы закрываются корректно
- [ ] Тесты проходят (`uv run pytest`)
- [ ] Линтер проходит (`uv run ruff check`)
- [ ] README.md обновлен при необходимости
- [ ] CHANGELOG.md обновлен для значимых изменений

