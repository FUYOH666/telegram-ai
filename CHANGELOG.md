# Changelog

All notable changes to this project will be documented in this file.

## [0.6.6] - 2025-11-06

### Fixed

- **Исправлена логика переходов между этапами продаж** - бот больше не "откатывается" назад и не задает повторные вопросы
  - Переходы между этапами теперь однонаправленные (только вперед, никогда назад)
  - Из этапа PRESENTATION нельзя вернуться в NEEDS_DISCOVERY, даже если есть слова "нужно", "хочу", "проблема"
  - Улучшена логика определения приветствия: не срабатывает на слова типа "расскажи" (содержит "привет")
  - Добавлены комментарии в код, объясняющие логику однонаправленных переходов
  - Теперь бот не будет "тупить" и задавать повторные вопросы на более поздних этапах

## [0.6.5] - 2025-11-06

### Fixed

- **Убраны ограничения длины из промптов, добавлены инструкции о полных ответах** - AI теперь раскрывает все шаги скрипта полностью
  - Убраны ограничения "Длина ответа: 2-4 предложения максимум" из промптов для NEEDS_DISCOVERY и PRESENTATION
  - Добавлены явные инструкции "Отвечай ПОЛНОСТЬЮ и развернуто, не обрезай ответ многоточием"
  - Улучшена инструкция для AI: система сама разобьет длинные ответы, AI не должен обрезать самостоятельно
  - Теперь AI будет раскрывать все аспекты и детали, без многоточий в конце ответов

## [0.6.4] - 2025-11-06

### Fixed

- **Убраны лимиты длины ответов для этапов NEEDS_DISCOVERY и PRESENTATION** - ответы больше не обрезаются на длинных транскриптах
  - Для этапа `NEEDS_DISCOVERY`: убран лимит 3500 символов (теперь без ограничения)
  - Для этапа `PRESENTATION`: убран лимит 4000 символов (теперь без ограничения)
  - Telegram сам ограничивает сообщения до 4096 символов, длинные ответы автоматически разбиваются на части
  - Добавлена инструкция для AI о разбиении очень длинных ответов на несколько сообщений

## [0.6.3] - 2025-11-06

### Fixed

- **Исправлена обработка стикеров и медиа** - стикеры, фото, видео и другие неподдерживаемые типы медиа теперь игнорируются без ответа
  - Убрана ошибочная реакция "Неверный формат голосового сообщения" при получении стикеров
  - Теперь бот не "палится" как бот при получении стикеров от новых пользователей
  - Неподдерживаемые типы медиа (стикеры, фото, видео, GIF, видеосообщения, контакты, геолокация, опросы) просто игнорируются без ответа

## [0.6.2] - 2025-11-06

### Fixed

- **Улучшена обработка коротких сообщений** - сообщения длиной 1 символ теперь игнорируются без ответа
  - Убрана формальная реакция "Сообщение слишком короткое" для одиночных символов
  - Теперь бот не "палится" как бот" при получении коротких сообщений типа "K"
  - Сообщения длиной <= 1 символа просто игнорируются (более естественное поведение)

## [0.6.1] - 2025-11-06

### Fixed

- **Исправлена проблема с обрезкой ответов AI** - ответы больше не обрезаются с многоточием без необходимости
  - Увеличены лимиты длины ответов для этапов продаж:
    - `NEEDS_DISCOVERY`: 1000 → 3500 символов
    - `PRESENTATION`: 3000 → 4000 символов (максимум для Telegram)
    - `OBJECTIONS`: 1500 → 2500 символов
  - Исправлена логика добавления многоточия: теперь добавляется только если текст обрезан в середине предложения
  - Если обрезка произошла по предложениям (последний символ - пунктуация), многоточие не добавляется

- **Исправлена проблема с обработкой голосовых сообщений** - ASR сервер теперь получает запросы корректно
  - Файл читается в память перед отправкой (исправлена проблема с закрытием файла до завершения отправки)
  - Увеличен таймаут ASR сервера: 60 → 180 секунд для длинных голосовых сообщений
  - Улучшена настройка таймаутов: отдельные таймауты для connect (15s), read (180s), write (30s), pool (10s)
  - Добавлено детальное логирование: размер файла, URL запроса, статус ответа, ошибки

### Changed

- Улучшено логирование обработки голосовых сообщений для диагностики проблем

### Technical

- Обновлены: `sales_flow.py` (увеличены лимиты), `ai_client.py` (улучшена логика многоточия), `voice_handler.py` (чтение файла в память, улучшенные таймауты), `config.yaml` (увеличен таймаут ASR)

## [0.6.0] - 2025-11-06

### Added

- **Автоматическое summary диалога перед встречей** - комплексная система генерации сводок для подготовки к встречам
  - Модуль `meeting_summary.py` для генерации структурированных сводок о клиентах
  - Автоматическая генерация summary при создании встречи (назначение времени консультации)
  - Анализ истории диалога: статистика, ключевые темы, тон общения, возражения, интересы
  - Генерация рекомендаций для встречи на основе собранной информации
  - Отправка структурированного отчета владельцу в Telegram (@WuWeiBuild)
  - Полная сводка включает: информацию о клиенте, бизнесе, метрики, проект, историю диалога, рекомендации

- **Расширенный сбор информации о клиенте** - детальная система слотов для sales flow
  - Расширен набор обязательных слотов для Sales AI интента:
    - Базовые слоты (приоритет 1): имя, компания, контакты, размер компании
    - Слоты о бизнесе (приоритет 2): сфера, проблемы, задачи, объем операций, метрики
    - Слоты о проекте (приоритет 3): цель, сроки, бюджет, доступ к данным, критерий успеха
  - Приоритетная система сбора информации: сначала базовые данные, затем о бизнесе, в конце о проекте
  - Обратная совместимость со старым слотом `domain` (автоматическое копирование в `company_domain`)

- **Методы анализа диалога** в `MeetingSummary`:
  - `analyze_conversation_history()` - анализ истории (статистика, темы, тон, возражения, интересы)
  - `generate_recommendations()` - рекомендации для встречи на основе слотов и истории
  - `generate_full_summary()` - полная сводка с историей и рекомендациями
  - `generate_owner_report()` - отчет для владельца в структурированном формате

- **Отправка summary владельцу** - автоматическая отправка отчета в Telegram
  - Метод `send_summary_to_owner()` в `client.py`
  - Настраиваемый получатель через `meeting_summary.owner_username` (по умолчанию: @WuWeiBuild)
  - Обработка FloodWait и ошибок при отправке
  - Опциональная отправка через `meeting_summary.send_to_owner` в конфиге

### Changed

- **Перенесена генерация summary** с момента заполнения всех слотов на момент создания встречи
  - Summary теперь генерируется только при фактическом назначении встречи
  - Это гарантирует, что владелец получает актуальную информацию именно перед встречей

- Обновлена конфигурация:
  - Добавлена секция `meeting_summary` в `config.yaml`
  - Новый класс `MeetingSummaryConfig` в `config.py`
  - Интеграция конфигурации в общий `Config` класс

- Расширена документация README.md:
  - Обновлен раздел "Формирование сводки для встречи" с описанием новой функциональности
  - Добавлен формат отчета для владельца
  - Описаны новые слоты и их приоритеты

### Technical

- Новый модуль: `src/telegram_ai/meeting_summary.py`
- Новые тесты: `tests/test_meeting_summary.py` (15+ тестов)
- Обновлены: `client.py` (интеграция генерации summary при создании встречи, отправка владельцу), `config.py` (MeetingSummaryConfig), `sales_flow.py` (расширенные слоты), `slot_extractor.py` (описания новых слотов)
- Удален: ранняя генерация summary при заполнении слотов (перенесена на момент создания встречи)

## [0.5.1] - 2025-11-05

### Added

- **Скрипт очистки истории** - `scripts/clear_all_history.py`
  - Полная очистка истории всех собеседников (сообщения, разговоры, контексты, rate limits)
  - Интерактивный режим с подтверждением или автоматический режим (`--yes`)
  - Статистика перед удалением для контроля
  - После очистки все собеседники общаются с ботом как с нуля

- **Анализ стабильности системы** - `STABILITY_ANALYSIS.md`
  - Детальный анализ готовности системы к работе 24/7
  - Оценка рисков и рекомендации по мониторингу
  - Описание сильных сторон и потенциальных проблем
  - Рекомендации по автоматизации и обслуживанию

- **Проверка запущенных экземпляров** - автоматическое обнаружение конфликтов
  - Предупреждение при запуске, если обнаружен другой процесс
  - Помогает предотвратить ошибку "database is locked"
  - Неблокирующая проверка (не останавливает запуск)

### Fixed

- **Критическое исправление блокировки БД при закрытии**
  - Добавлен метод `close()` в класс `Memory` для корректного закрытия SQLAlchemy engine
  - Улучшен порядок закрытия ресурсов: Memory закрывается перед Telethon клиентом
  - Обработка ошибок "database is locked" при закрытии (не критично, логируется как warning)
  - Исправлена проблема с блокировкой SQLite при сохранении состояния сессии Telethon

- **Улучшена обработка ошибок при остановке приложения**
  - Все компоненты закрываются в правильном порядке
  - Ошибки при закрытии не падают приложение, а логируются
  - Гарантированное освобождение ресурсов

### Changed

- Обновлена документация README.md:
  - Добавлен раздел "Очистка истории всех собеседников"
  - Обновлены инструкции по решению проблем с блокировкой БД

### Technical

- Новый метод: `Memory.close()` для освобождения соединений с БД
- Обновлен: `client.py` (улучшен порядок закрытия ресурсов)
- Обновлен: `main.py` (добавлена проверка запущенных экземпляров)
- Новые файлы: `scripts/clear_all_history.py`, `STABILITY_ANALYSIS.md`

## [0.5.0] - 2025-11-05

### Added

- **Умная система защиты от блокировок Telegram** - комплексная система rate limiting
  - Глобальный rate limiter на уровне аккаунта (28 сообщений/минуту, 600/час)
  - Автоматическая обработка FloodWait от Telethon с ожиданием и retry
  - Адаптивная система лимитов с автоматическим снижением при FloodWait и восстановлением
  - Умные лимиты по типам чатов (личные: 25/мин, группы: 12/мин, каналы: 5/мин)
  - Метод `safe_reply()` для безопасной отправки сообщений с обработкой ошибок
  - История FloodWait событий для мониторинга и анализа
  - Статистика FloodWait в health check команде

- **Health check команда** - диагностика состояния приложения
  - Команда `uv run telegram-ai health` для проверки всех компонентов
  - Проверка версий, конфигурации, доступности серверов, БД, интеграций
  - Статистика FloodWait и текущих адаптивных лимитов

- **Утилита управления блокировками** - `scripts/reset_rate_limits.py`
  - Просмотр статуса блокировок (глобальных и пользовательских)
  - Сброс всех блокировок или отдельных пользователей
  - Показ оставшегося времени блокировки

- **Руководство по расширению лимитов** - `RATE_LIMITS_GUIDE.md`
  - Детальное описание текущих лимитов
  - Стратегии безопасного расширения
  - Рекомендации по мониторингу и оптимизации

### Changed

- **Расширены лимиты для более активного общения:**
  - Per-user: 10→15 сообщений/мин, 50→80/час
  - Глобальный: 25→28 сообщений/мин, 500→600/час
  - Личные чаты: 20→25 сообщений/мин
  - Минимальный интервал: 2→1 секунда
  - Время блокировки: 10→3 минуты

- **Улучшена адаптивная система:**
  - Период восстановления: 10→5 минут
  - Скорость восстановления: 5%→10% за период

- Обновлена конфигурация rate limiting в `config.yaml`:
  - Добавлена секция `global` для глобальных лимитов
  - Добавлена секция `adaptive` для адаптивных настроек
  - Добавлена секция `chat_type_limits` для лимитов по типам чатов
- Улучшена обработка ошибок отправки сообщений через `safe_reply()`
- Все основные `event.reply()` заменены на `safe_reply()` с обработкой FloodWait
- Расширена документация README.md с описанием новых функций защиты и утилиты сброса блокировок

### Fixed

- Исправлены ошибки линтера в `calendar.py` (неиспользуемый импорт, f-string без плейсхолдеров)

### Technical

- Новые модели БД: `GlobalRateLimit`, `FloodWaitHistory`
- Новые классы: `GlobalRateLimiter` в `rate_limiter.py`
- Новые скрипты: `scripts/reset_rate_limits.py`
- Новые документы: `RATE_LIMITS_GUIDE.md`
- Обновлены: `client.py` (интеграция GlobalRateLimiter, safe_reply), `config.py` (новые конфигурации), `memory.py` (новые модели), `main.py` (health check с адаптивными лимитами), `calendar.py` (исправления линтера)
- Добавлен `uv.lock` в репозиторий (источник истины для зависимостей)

## [0.4.1] - 2025-11-05

### Changed

- **Подготовка к production деплою** - очистка проекта от временных файлов и данных
  - Удалены временные MD-файлы (PROJECT_SUMMARY.md, SIMILAR_PROJECTS_ANALYSIS.md, rm.md, telegram-ai-assistant-setup.plan.md)
  - Удалены временные скрипты (clear_user_data.py, test_ai_connection.py)
  - Очищена база данных от тестовых данных (55 сообщений, 2 разговора)
  - Очищены логи от тестовых записей
  - Проект готов к production запуску

## [0.4.0] - 2025-11-05

### Added

- **RAG система для базы знаний компании** - комплексная система поиска релевантной информации
  - Модуль `rag.py` для управления базой знаний компании
  - Автоматическая загрузка документации из директории `knowledge_base/` при старте
  - Семантический поиск релевантной информации перед генерацией ответа
  - Интеграция с VectorMemory (ChromaDB) для векторного поиска
  - Поддержка текстовых файлов (.txt, .md) с автоматическим разбиением на чанки
  - Автоматическое добавление найденной информации в контекст для более точных ответов

- **База знаний из сайта и GitHub** - автоматизированное создание базы знаний
  - Скрипт `extract_website_content.py` для парсинга сайта scanovich.ai
  - Скрипт `extract_github_projects.py` для анализа всех GitHub репозиториев через GitHub CLI
  - Скрипт `build_knowledge_base.py` для валидации и сборки базы знаний
  - Структурированная база знаний с 38+ документами:
    - Информация о компании (5 файлов)
    - Описания проектов (19 файлов из 17 репозиториев)
    - Технологии и компетенции (6 файлов)
    - Примеры решений по индустриям (5 файлов)
    - Возможности и универсальность (3 файла)

- **Конфигурация RAG системы** - настройки для управления базой знаний
  - `rag.enabled` - включить/выключить RAG систему
  - `rag.knowledge_base_path` - путь к директории с документацией
  - `rag.max_results` - максимальное количество результатов поиска (по умолчанию: 5)
  - `rag.min_score` - минимальный score для включения результата (по умолчанию: 0.7)
  - `rag.auto_load_on_startup` - автоматическая загрузка при старте

### Changed

- Обновлена конфигурация RAG системы в `config.yaml`:
  - RAG включен по умолчанию (`enabled: true`)
  - Увеличен `max_results` до 5 для лучшего покрытия информации
  - Путь к базе знаний: `./knowledge_base`

- Расширена документация README.md:
  - Добавлен раздел "RAG система для базы знаний компании"
  - Добавлен раздел "Обновление базы знаний"
  - Обновлена структура проекта с новыми директориями

- Улучшен скрипт `build_knowledge_base.py`:
  - Добавлена валидация категории `capabilities`
  - Исключение `README.md` из подсчета документов для точной статистики
  - Улучшено описание структуры базы знаний в README.md
  - Добавлены инструкции по использованию скрипта

### Technical

- Новый модуль: `src/telegram_ai/rag.py`
- Новые скрипты: `scripts/extract_website_content.py`, `scripts/extract_github_projects.py`, `scripts/build_knowledge_base.py`
- Обновлены: `ai_client.py` (поддержка RAG), `client.py` (инициализация RAG), `config.py` (RAGConfig)
- База знаний использует отдельную коллекцию ChromaDB (`rag_knowledge_base`)

## [0.3.0] - 2025-11-05

### Added

- **Автоматическое извлечение слотов через LLM** - `SlotExtractor` для автоматического извлечения информации из сообщений
  - Извлечение бюджета, сроков, целей проекта, контактной информации
  - Поддержка слотов для Sales AI и Real Estate интентов
  - Fallback на ручные вопросы если LLM не нашел слот
  - Сокращение количества вопросов на 30-50%

- **Summarization для длинных контекстов** - автоматическое создание резюме старых сообщений
  - Таблица `ConversationSummary` для хранения summary
  - Автоматическое создание summary при превышении `context_window`
  - Включение summary в начало контекста для сохранения важной информации
  - Настраиваемый порог через `memory.summary_threshold`

- **ML-based Intent Classification с confidence scores** - улучшенная классификация намерений
  - LLM-based классификация с оценкой уверенности (0.0-1.0)
  - Fallback на keyword-based при низкой уверенности (<0.7)
  - Улучшение точности классификации на 15-25%
  - Логирование confidence scores для анализа

- **Векторный поиск в истории диалогов** - семантический поиск релевантных сообщений
  - Интеграция ChromaDB для векторного хранилища
  - Векторизация сообщений при сохранении
  - Автоматический поиск релевантных сообщений из истории
  - Комбинирование временного и семантического поиска в контексте
  - Поддержка embeddings через LLM API или встроенные embeddings ChromaDB

- **Роадмап улучшений** - `rm.md` с планом развития проекта
- **Анализ похожих проектов** - `SIMILAR_PROJECTS_ANALYSIS.md` с исследованием

### Changed

- Обновлена конфигурация с новыми параметрами:
  - `slot_extraction.enabled` - включить автоматическое извлечение слотов
  - `intent_classifier.use_llm` - использовать LLM для классификации
  - `intent_classifier.confidence_threshold` - порог уверенности
  - `memory.auto_summarize` - автоматическая summarization
  - `memory.summary_threshold` - порог для создания summary
  - `memory.vector_search_enabled` - включить векторный поиск
  - `memory.vector_db_path` - путь к ChromaDB

- Обновлена структура проекта с новыми модулями
- Расширены тесты для нового функционала

### Technical

- Добавлена зависимость `chromadb>=0.4.0`
- Новые модули: `slot_extractor.py`, `vector_memory.py`
- Обновлены: `memory.py`, `intent_classifier.py`, `client.py`, `config.py`
- Все тесты проходят (92/92)

## [0.2.1] - 2025-11-05

### Added

- **Скрипт очистки данных пользователя** - `clear_user_data.py` для полной очистки истории разговоров
  - Удаление всех сообщений, разговоров, контекста и rate limit записей для конкретного пользователя
  - Опция `--list` для просмотра всех пользователей в базе данных
  - Интерактивное подтверждение перед удалением данных

- **Метод очистки данных пользователя** - `Memory.delete_user_data()` для программной очистки
  - Удаление всех связанных данных пользователя из БД
  - Возвращает статистику удаленных записей

### Changed

- **Улучшена обработка китайского языка** - явное указание на упрощенный китайский (Simplified Chinese)
  - Обновлено название языка на "упрощенном китайском (Simplified Chinese)"
  - Добавлена специальная инструкция для китайского языка в системный промпт
  - Инструкция для китайского языка имеет максимальный приоритет (добавляется в начало промпта)
  - Явный запрет на использование английского, русского и традиционного китайского
  - Добавлена fallback проверка для гарантии наличия инструкции

- **Обновлен системный промпт** - добавлены правила для китайского языка
  - Явное указание на упрощенный китайский (简体中文)
  - Запрет на переключение на другие языки

### Fixed

- **Запрет на запрос изображений** - добавлено явное ограничение в системный промпт
  - Модель не обрабатывает изображения, поэтому AI больше не будет просить скриншоты или фото
  - Предложение альтернатив: описание словами или другой канал связи

## [0.2.0] - 2025-01-XX

### Added

- **Интеграция Web Search MCP** - автоматический поиск актуальной информации в интернете
  - Поддержка MCP Web Search сервера для получения актуальных данных
  - Автоматическое определение необходимости поиска по ключевым словам
  - Лимиты на количество запросов за диалог (настраиваемые)
  - Форматирование результатов поиска для включения в контекст AI

- **Улучшенный системный промпт** - более живое и естественное общение
  - Усиленная роль "Александр, основатель Scanovich.ai" с конкретным опытом
  - Правила эмпатии и активного слушания
  - Консультативный подход в продажах (доверенный партнёр)
  - Больше примеров живого общения (few-shot)

- **Динамические параметры генерации** - тонкая настройка по этапам продаж
  - Автоматическая настройка temperature, max_tokens, top_p, frequency_penalty, presence_penalty
  - Разные параметры для каждого этапа скрипта продаж
  - Оптимизация для Small Talk (более креативно) и Sales (более детерминированно)

- **Улучшенные модификаторы этапов** - более естественные реакции
  - Примеры естественных реакций для каждого этапа
  - Усиленные правила длины ответов
  - Правила использования имени пользователя

- **Улучшенные промпты для слотов** - открытые вопросы вместо допроса
  - Более естественные формулировки
  - Убраны "допросные" тона

- **Улучшенный классификатор намерений** - расширенные ключевые слова и веса
  - Расширенные списки ключевых слов для Sales AI и Real Estate
  - Веса для важных слов (более важные слова = больше вес)
  - Улучшенная логика сохранения контекста
  - Логирование результатов классификации для анализа

- **Поддержка имени пользователя** - извлечение и использование имени из Telegram API
  - Автоматическое сохранение имени пользователя в контексте
  - Использование имени в промптах (периодически, не в каждом сообщении)

### Changed

- Системный промпт полностью переработан для более живого общения
- Модификаторы этапов обновлены с примерами и правилами консультативного подхода
- Промпты для запроса слотов сделаны более открытыми и естественными
- Параметры генерации теперь динамически настраиваются по этапам

### Technical

- Новый модуль `web_search.py` для интеграции с MCP Web Search
- Расширен `ai_client.py` для поддержки дополнительных параметров генерации
- Обновлен `config.py` с конфигурацией Web Search
- Добавлены тесты для Web Search интеграции

## [0.1.0] - 2025-11-05

### Added

- Базовая функциональность Telegram AI-ассистента для личного аккаунта
- Интеграция с локальным AI-сервером (OpenAI-compatible API)
- Память и контекст диалогов через SQLite
- Интеграция с Google Calendar (опционально)
- Конфигурация через YAML и ENV переменные
- Автоматические ответы на сообщения в личных чатах
- Команды для управления календарем (`/calendar`, `/events`, `/create_event`)

### Technical

- Python 3.12
- Telethon для работы с личным аккаунтом Telegram
- SQLAlchemy для работы с БД
- Pydantic Settings для конфигурации
- Tenacity для ретраев
- httpx для HTTP запросов

