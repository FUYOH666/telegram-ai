Умная система защиты от блокировок Telegram
Анализ текущей ситуации
Текущие лимиты:

10 сообщений/минуту на пользователя
50 сообщений/час на пользователя
Минимум 2 секунды между сообщениями
Только per-user лимиты, нет глобальных
Лимиты Telegram для User API (Telethon):

Рекомендуется: 1 сообщение/секунду (60/мин теоретически)
Безопасно: 20-30 сообщений/минуту на весь аккаунт
При превышении: FloodWait с временем ожидания
Блокировка аккаунта: при регулярных нарушениях на 12-24 часа
Проблемы текущей реализации:

Нет глобального лимита на уровне аккаунта
Нет обработки FloodWait от Telethon
Статические лимиты без адаптации
Нет различения типов чатов (личные/группы)
План улучшений
1. Глобальный rate limiter на уровне аккаунта
Файлы:

src/telegram_ai/rate_limiter.py - добавить класс GlobalRateLimiter
src/telegram_ai/memory.py - добавить модель GlobalRateLimit
src/telegram_ai/config.py - добавить GlobalRateLimitingConfig
Изменения:

Отслеживание общего количества отправленных сообщений за минуту/час
Глобальный лимит: 25 сообщений/минуту (безопасный запас от 30)
Глобальный лимит: 500 сообщений/час (защита от массовой рассылки)
Блокировка всех отправок при превышении глобального лимита
2. Обработка FloodWait от Telethon
Файлы:

src/telegram_ai/client.py - обернуть все event.reply() в обработчик FloodWait
src/telegram_ai/rate_limiter.py - добавить метод handle_flood_wait()
Изменения:

Перехватывать FloodWaitError от Telethon
Автоматически ждать указанное время
Записывать FloodWait события для адаптации лимитов
Логировать все FloodWait для анализа
При FloodWait > 60 секунд - критическое предупреждение
3. Адаптивная система лимитов
Файлы:

src/telegram_ai/rate_limiter.py - добавить класс AdaptiveRateLimiter
src/telegram_ai/memory.py - добавить модель FloodWaitHistory
Изменения:

Отслеживание истории FloodWait событий
Автоматическое снижение лимитов при получении FloodWait
Постепенное восстановление лимитов при отсутствии FloodWait
Алгоритм: при FloodWait снижаем лимиты на 20%, каждые 10 минут без FloodWait восстанавливаем на 5%
4. Умные лимиты для разных типов чатов
Файлы:

src/telegram_ai/config.py - добавить ChatTypeRateLimits
src/telegram_ai/rate_limiter.py - учитывать тип чата при проверке
Изменения:

Личные чаты: 20 сообщений/минуту (более либерально)
Группы: 10 сообщений/минуту (более консервативно)
Каналы: 5 сообщений/минуту (самый консервативный)
Конфигурируемые через config.yaml
5. Улучшенная обработка ошибок отправки
Файлы:

src/telegram_ai/client.py - добавить декоратор safe_reply() с обработкой FloodWait
Изменения:

Обертка для всех event.reply() с автоматической обработкой FloodWait
Логирование всех ошибок отправки
Retry с экспоненциальной задержкой при временных ошибках
Fail-fast при критических ошибках (например, заблокирован аккаунт)
6. Мониторинг и метрики
Файлы:

src/telegram_ai/rate_limiter.py - добавить методы статистики
Обновить health check команду
Изменения:

Метрики: количество FloodWait за период, средний FloodWait time
Статистика использования лимитов (per-user и global)
Health check показывает текущие адаптивные лимиты
7. Конфигурация
Файлы:

config.yaml - добавить новые секции
Изменения:

rate_limiting:
  enabled: true
  # Per-user лимиты (как сейчас)
  messages_per_minute: 10
  messages_per_hour: 50
  
  # Глобальные лимиты на уровне аккаунта
  global:
    enabled: true
    messages_per_minute: 25  # безопасный запас от 30
    messages_per_hour: 500
    
  # Адаптивные лимиты
  adaptive:
    enabled: true
    reduction_on_floodwait_percent: 20  # снижение на 20% при FloodWait
    recovery_period_minutes: 10  # проверка восстановления каждые 10 минут
    recovery_increment_percent: 5  # восстановление на 5% за период
    
  # Лимиты по типам чатов
  chat_type_limits:
    private: 20  # сообщений/минуту для личных чатов
    group: 10    # сообщений/минуту для групп
    channel: 5   # сообщений/минуту для каналов
Последовательность реализации
Добавить глобальный rate limiter (критично)
Добавить обработку FloodWait (критично)
Добавить адаптивную систему (важно)
Добавить умные лимиты по типам чатов (улучшение)
Улучшить обработку ошибок (улучшение)
Добавить мониторинг (опционально)
Ожидаемый результат
Защита от блокировок аккаунта через глобальные лимиты
Автоматическая адаптация к лимитам Telegram
Умная система с разными лимитами для разных типов чатов
Надежная обработка FloodWait с автоматическим ожиданием
Баланс между отзывчивостью и безопасностью